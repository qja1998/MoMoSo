import re
import os
import asyncio
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI
from langchain.prompts import PromptTemplate
from db_manager import init_db, insert_novel, insert_chapter

load_dotenv()

# OpenAI API 키
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

# OpenAI 모델 설정
llm = ChatOpenAI(
    openai_api_key=OPENAI_API_KEY,
    model="gpt-4o-mini",
)

# 1화 생성용 프롬프트 템플릿
prompt_template_1st = PromptTemplate(
    input_variables=["genre", "title", "worldview", "synopsis", "characters"],
    template="""
    당신은 주어진 정보를 바탕으로 창의적이고 몰입감 있는 소설을 집필하는 전문 소설 작가입니다.
    제공된 정보를 활용하여 소설의 첫 번째 챕터(서문)를 작성해 주세요.

    목표는 소설의 구성 단계인 '발단 → 전개 → 위기 → 절정 → 결말'에 따라, 선택된 장르, 톤, 스타일, 그리고 구조를 기반으로, 
    기발한 사건, 매력적인 캐릭터, 그리고 예기치 않은 절정을 가진 창의적이고 매력적인 이야기를 작성하는 것입니다.

    **소설의 총 챕터는 10챕터로 구성되며, 6챕터에서 절정에 이르는 갈등이 발생합니다.**

    - 소설의 톤과 분위기는 {genre} 장르에 맞게 설정하세요.
    - 서술 방식은 생동감 있고 감각적인 묘사를 포함하며, 대사는 자연스럽고 캐릭터의 개성을 반영하도록 작성하세요.
    - 첫 챕터에서는 주인공을 등장시키고, 독자의 흥미를 끌 수 있는 주요 사건 또는 갈등의 단서를 제시하세요.
    - 스토리의 배경을 독자가 쉽게 이해할 수 있도록 자연스럽게 설명하되, 장황하지 않도록 주의하세요.
    - 대화와 행동 묘사를 활용하여 장면을 생동감 있게 표현하세요.
    - 문장이 매끄럽게 이어지도록 흐름을 유지하며, 문법적으로 올바른 문장을 작성하세요.
    - 소설의 첫 챕터(서문)는 한글 기준으로 작성하며, 공백을 제외한 문자 수가 500자 이상 700자 이하가 되도록 작성해주세요. 문장 구성과 흐름은 자연스럽게 유지하면서도 요구되는 분량을 철저히 충족시키도록 주의해주세요.
    - 단, 문단 간격은 문자 수에 포함하지 않습니다.
    
    소설의 장르: {genre}
    소설의 제목: {title}
    세계관 소개: {worldview}
    시놉시스: {synopsis}
    등장인물: {characters}

    **소설 첫 챕터(서문)**
    """
)

prompt_template_1st = PromptTemplate(
    input_variables=["genre", "title", "worldview", "synopsis", "characters"],
    template="""
    당신은 전문 소설 작가로서, 주어진 정보를 바탕으로 창의적이고 몰입감 있는 첫 번째 챕터(서문)를 작성해야 합니다. 
    이 소설은 **{genre}** 장르에 속하며, 소설의 톤과 스타일은 그에 맞춰야 합니다. 
    이야기의 중심에는 여러 복잡한 감정선을 지닌 인물들이 등장하며, 그들의 내면적인 갈등이 중요한 플롯의 일부입니다.

    **첫 번째 챕터(서문) 작성 지침**:
    1. **소설의 장르**: {genre} 장르는 그 특성에 맞는 분위기와 사건 전개를 요구합니다. 예를 들어, **SF** 장르라면 미래적이고 과학적인 요소가 포함되어야 하며, **판타지**라면 마법이나 초자연적인 요소가 핵심적이어야 합니다. 
    2. **세계관**: {worldview}에서 설명된 설정을 고려하여, 이야기가 펼쳐지는 세계의 규칙과 환경을 잘 반영해야 합니다. 예를 들어, 마법이 존재하는 세계라면 그 법칙이나 제약을 명확히 하세요.
    3. **등장인물**: {characters}에 나와 있는 등장인물들을 생동감 있게 묘사해야 합니다. 각 인물은 고유한 동기와 갈등을 가지고 있으며, 그들의 내면적인 변화를 중요하게 다뤄야 합니다. 
        - 각 인물의 성격, 나이, 역할이 이야기에 어떤 영향을 미칠지 생각해 보세요.
        - 등장인물의 동기와 감정을 세밀하게 묘사하여 독자가 그들과 함께 이야기 속에 몰입할 수 있도록 하세요.
    4. **스토리 구조**: 소설은 **5단계 구성** (발단 → 전개 → 위기 → 절정 → 결말)으로 진행됩니다. 
        - **발단**: 첫 번째 챕터에서 주인공을 소개하고, 이야기가 시작되는 주요 사건이나 갈등을 소개하세요.
        - **전개**: 주인공이 사건에 반응하며 중요한 결정을 내리게 되는 과정을 설명하세요.
        - **위기**: 주인공이 직면하는 갈등과 위기 상황을 극적으로 묘사하세요.
        - **절정**: 갈등이 최고조에 이르는 순간, 독자의 긴장을 고조시키는 중요한 사건을 설정하세요.
        - **결말**: 첫 번째 챕터의 결말은 독자가 다음 이야기를 기대하게 만들 수 있도록, 열린 결말로 끝내세요.
    5. **대화와 행동 묘사**: 대화와 행동은 등장인물의 감정과 성격을 드러내는 중요한 요소입니다. 각 등장인물이 어떻게 대화하는지, 어떤 행동을 취하는지에 따라 그들의 성격이 드러나도록 하세요.
    6. **서술 스타일**: 서술자의 시점은 **3인칭 제한적 시점**으로 설정하세요. 주인공의 생각과 감정을 중심으로 사건을 진행시키되, 필요할 경우 외부의 시각을 통해 추가 정보를 제공합니다. 문장은 간결하면서도 감정이 잘 전달되도록 구성하세요.

    소설의 장르: {genre}
    소설의 제목: {title}
    세계관 소개: {worldview}
    시놉시스: {synopsis}
    등장인물: {characters}

    **소설 첫 챕터(서문)**
    """
)

chain_1st = prompt_template_1st | llm

async def generate_first_chapter(genre: str, title: str, worldview: str, synopsis: str, characters: list) -> str:
    """
    주어진 장르, 제목, 세계관, 시놉시스, 등장인물 정보를 바탕으로 소설 1화(첫 챕터)를 생성
    """
    characters_str = "\n".join([
        f"- 이름: {char['name']}, 역할: {char['role']}, 나이: {char['age']}, 성별: {char['sex']}, 직업: {char['job']}, 프로필: {char['profile']}"
        for char in characters
    ])

    input_data = {
        "genre": genre,
        "title": title,
        "worldview": worldview,
        "synopsis": synopsis,
        "characters": characters_str
    }

    generated_text = await asyncio.to_thread(chain_1st.invoke, input_data)
    return generated_text

def clean_filename(filename: str) -> str:
    # Windows에서 파일 이름에 사용할 수 없는 문자 목록: <>:"/\|?*
    return re.sub(r'[<>:"/\\|?*]', '-', filename)

async def main():
    # 예시 데이터
    genre = "SF, 디스토피아, 배틀로얄, 초능력"
    title = "이터널 리턴: 아글라이아의 실험"
    worldview = """
    지구가 형성될 때부터 존재했던 미지의 힘, **VF(Variable Force)**. 
    이 힘은 자연현상을 초월하는 강력한 능력을 부여하며, 운석을 지구로 끌어들이거나 특정 생명체에 변칙적인 힘을 발현시키는 등 신비로운 성질을 가지고 있다.

    그러나 VF의 존재는 인간에게도 미미한 영향을 끼쳤고, 그 흔적은 신화나 전설, 종교적 이야기 속에서나 남아 전해져 왔다.
    초인적인 신체 능력, 염동력, 예지력 등 전설 속에 등장하는 능력들은 실상 VF의 영향을 받은 인간들일 가능성이 컸다.
    하지만 그 횟수는 극히 적었고, 인간이 이를 과학적으로 증명하기엔 너무나도 부족한 데이터뿐이었다.

    이에 흥미를 가진 **비밀 연구 조직 '아글라이아'**는 VF의 존재를 추적하고 연구하기 시작했다.
    그들은 VF가 어떻게 발현되고, 특정한 조건에서 어떤 성질을 띄며, 인간에게 어떤 영향을 끼치는지를 실험하기 위해 2001년, 루미아 섬의 원주민들을 강제로 이주시키고,
    그곳을 **살아남기 위해 서로를 죽여야만 하는 전장으로 만들었다**.

    그러나 VF의 가능성은 끝이 없었고, 예상조차 할 수 없는 변칙성을 보여주었다.
    이에 따라, 아글라이아는 실험체의 모집 범위를 넓혀 **전 세계에서 특출난 재능을 가진 사람들, 혹은 VF 발현 가능성이 있는 인물들을 강제적으로 납치하거나 모집**하였다.

    기술력 면에서도 세계 최상급을 자랑하는 아글라이아는, 2001년 실험이 시작된 이후부터 지금까지  
    **실험체들이 늙지 않도록 조치하고, 실험이 시작될 때마다 기억을 지움으로써 실험을 '영원히 반복'하고 있다**.

    현재 진행 중인 **2차 실험**에서는, VF의 발현을 더욱 효과적으로 끌어내기 위해 실험체들에게 극한의 상황을 부여하고 있다.  
    이들은 강제적으로 폭탄 목걸이를 착용한 채 루미아 섬에서 생존해야 하며, 서로를 죽이지 않으면 금지구역 설정과 강력한 '야생동물' 투입으로 강제적으로 도태된다.  

    그러나 **일부 실험체들은 이 실험을 끝낼 방법을 찾기 위해 움직이기 시작했다...**
    """
    synopsis = """
    견습 수녀 키아라는 신의 뜻을 따라 어둠 속에서 빛을 전하려 했지만, 세상은 그녀를 외면했고 그녀의 신앙은 흔들리기 시작했다.
    잔혹한 사채업자 다르코는 폭력과 돈이 세상의 진리라 믿었고, 누구도 그의 길을 막을 수 없었다.
    이들이 강제로 끌려온 곳은 ‘아글라이아’라 불리는 정체불명의 실험 구역.

    여기서 실험체들은 서로를 죽여야만 살아남을 수 있으며, 모든 사망자는 기억을 잃고 실험이 재시작되는 ‘이터널 리턴’의 굴레에 갇혀 있다.
    이들은 단순한 생존을 넘어, 이 실험을 끝내기 위한 방법을 찾기 시작한다.

    그러나 아글라이아의 지도자 안젤리카와 급진적인 부소장 에르샤, 그리고 그들이 창조한 인류를 초월한 존재 ‘이바’와 ‘에키온’이 이 실험을 지배하고 있다.
    그들의 계획은 무엇이며, 실험체들은 이 끝없는 실험에서 벗어날 수 있을까?

    살아남기 위한 처절한 싸움 속에서, 진정한 자유를 쟁취하기 위한 전투가 벌어진다.
    키아라와 다르코는 이 실험을 끝내기 위해 함께 싸워나가며, VF의 비밀을 풀어나가기 시작한다.
    이 과정에서 키아라, 다르코 외의 실험체들을 만나고 마음이 맞는 실험체들과 함께 협력한다.
    이 이야기의 끝은 다르코의 희생으로 키아라가 VF의 비밀을 풀어내고, 실험체들이 자유롭게 풀려남으로써 끝난다.
    """
    characters = [
        {
            "name": "키아라",
            "role": "주인공",
            "age": 21,
            "sex": "여성",
            "job": "견습 수녀",
            "profile": """
            태어나자마자 폐쇄적인 성당에 맡겨졌고, 매일 하느님의 전능을 세뇌 받다시피 교육받는다.
            바깥 외출이 허가된 이후 그녀는 하느님의 사도로서 충실하기 위해 가장 어둡고 더러운 곳에서 전도를 시작했지만, 그녀가 마주한 현실은 배운 것 보다 훨씬 더 냉담했다.
            그 과정에서 충실한 사도인 자신을 지켜주지 않는 하느님을 부정하는 생각을 품게 되고, 그런 자기 자신에 대한 강한 혐오감을 가지게 된다.
            아름다운 것, 고결한 것을 보게 되면 자격지심으로 인해 폭주한다.

            폭력과 죄악을 증오하지만, 동시에 아름다움과 순수한 것에 대한 강한 집착을 가지고 있다. 
            실험 구역에서 생존을 위해 자신이 믿었던 신념과 싸우며 변화해 나간다.
            """
        },
        {
            "name": "다르코",
            "role": "조력자",
            "age": 35,
            "sex": "남성",
            "job": "사채업자",
            "profile": """
            돈과 폭력이 세상의 모든 것을 해결해준다고 믿는 남자.
            잔혹하고 무자비한 성격으로, 자신이 원하는 건 전부 빼앗아야 직성이 풀린다.
            경찰인 아버지 밑에서 자랐으나 어렸을 때부터 성격이 포악했다.
            빚에 허덕이는 아버지에게 버려질 때, 그는 속으로 환호했다.
            '드디어 이 지옥 같은 굴레에서 벗어날 수 있겠구나.'
            이후 다르코는 자신이 사랑하는 폭력을 사용해서 돈을 벌기 시작했다.
            어떤 일이든 돈과 폭력은 그에게 늘 최우선 순위가 되었고, 삶의 전부가 되었다.
            어쩌면 그가 담보라는 이름으로 팔려나갔을 때, 깨달았을지도 모른다.
            돈과 폭력이 이 세상의 전부라는 것을.

            아글라이아의 실험에 참가하게 되면서도 그는 여전히 자신의 신념을 지키려 하지만, 
            점점 이 실험이 단순한 돈과 권력을 넘어선 것임을 깨닫게 된다. 
            자신이 시스템의 일부로서 이용당하고 있음을 깨닫고, 실험을 끝낼 방법을 찾기 시작한다.
            """
        },
        {
            "name": "에르샤",
            "role": "대적자 (아글라이아 부소장)",
            "age": "40대 후반 (실제 나이 불명)",
            "sex": "여성",
            "job": "아글라이아 부소장",
            "profile": """
            아글라이아의 실험을 급진적으로 추진하는 인물. 실험체들의 한계를 시험하기 위해 직접 서울에 테러를 감행하고,
            괴물 ‘스킬라’를 풀어놓아 실험체들을 극한의 상황으로 몰아넣었다. 
            온건한 안젤리카와는 자주 대립하며, 더욱 강력한 존재를 창조하려는 목표를 가지고 있다. 
            그녀는 실험체 ‘이바’를 자신의 궁극적인 창조물로 보고 있으며, 실험의 결과를 조작하려 한다.
            """
        },
        {
            "name": "이바 (Eva)",
            "role": "불완전한 신 인류",
            "age": "불명 (신체적 나이 20대 초반)",
            "sex": "여성",
            "job": "실험체",
            "profile": """
            아글라이아가 창조한 신 인류 중 하나. 인간을 초월하는 신체 능력을 가졌으며, 
            모든 감정을 제거당한 채 실험에 참여하고 있다. 
            하지만, 실험을 거듭할수록 사라졌다고 믿었던 감정이 되살아나기 시작하며, 
            인간성과 신 인류 사이에서 갈등하게 된다. 
            자신을 ‘창조자’로 여기는 에르샤와의 관계도 점점 변화해 간다.

            말을 걸어도 상냥하게 웃어줄 뿐, 자신을 드러낼 수 있는 대답은 하지 않는다.
            그런 모습에서 어딘가 비밀스럽고 신비로운 분위기가 느껴진다.

            통각이 둔한 상태라 무언가에 잘 부딪치고 넘어진다.
            멍들고 상처가 나도 잘 모른다.
            조금만 건드려도 부서질 것 같은 가녀린 몸이지만, 모두를 두렵게 만들 강력한 힘을 숨기고 있다.
            """
        }
    ]

    # 소설 생성
    novel_id = insert_novel(genre, title, worldview, synopsis, characters)
    first_chapter = await generate_first_chapter(genre, title, worldview, synopsis, characters)

    # 결과물 파일로 저장
    output_dir = os.path.join(os.getcwd(), "novel")
    os.makedirs(output_dir, exist_ok=True)
    clean_title = clean_filename(title)
    file_name = os.path.join(output_dir, f"{clean_title}_1화.txt")
    with open(file_name, 'w', encoding='utf-8') as file:
        file.write(first_chapter)
    
    # DB에 저장
    insert_chapter(novel_id, 1, first_chapter)
    print(f"파일 저장 완료: {file_name}")

if __name__ == "__main__":
    asyncio.run(main())