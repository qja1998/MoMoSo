image: alpine:latest  # ê²½ëŸ‰í™”ëœ ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©

stages:
  - build
  - test
  - deploy

variables:
  IMAGE_BACKEND: kwon0528/test-backend
  IMAGE_FRONTEND: kwon0528/test-frontend
  TAG: $CI_COMMIT_REF_NAME

before_script:
  - apk add --no-cache docker docker-compose  # `dind` ì—†ì´ ì§ì ‘ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
  - docker info
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

  - apk add --no-cache docker-compose
  - mkdir -p ~/.ssh
  - echo "ðŸ”‘ Set ENV"

  - echo "DOCKER_USERNAME=$DOCKER_USERNAME" >> .env
  - echo "DOCKER_PASSWORD=$DOCKER_PASSWORD" >> .env
  - echo "DEPLOY_SSH_PRIVATE_KEY=$DEPLOY_SSH_PRIVATE_KEY" >> .env
  - echo "TWILIO_AUTH_TOKEN=$TWILIO_AUTH_TOKEN" >> .env
  - echo "TWILIO_VERIFY_SID=$TWILIO_VERIFY_SID" >> .env
  - echo "SECRET_KEY=$SECRET_KEY" >> .env
  - echo "ALGORITHM=$ALGORITHM" >> .env
  - echo "ACCESS_TOKEN_EXPIRE_MINUTES=$ACCESS_TOKEN_EXPIRE_MINUTES" >> .env
  - echo "REFRESH_TOKEN_EXPIRE_DAYS=$REFRESH_TOKEN_EXPIRE_DAYS" >> .env
  - echo "MAIL_USERNAME=$MAIL_USERNAME" >> .env
  - echo "MAIL_PASSWORD=$MAIL_PASSWORD" >> .env
  - echo "MAIL_FROM=$MAIL_FROM" >> .env
  - echo "MAIL_PORT=$MAIL_PORT" >> .env
  - echo "MAIL_SERVER=$MAIL_SERVER" >> .env
  - echo "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" >> .env
  - echo "GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET" >> .env
  - echo "KAKAO_CLIENT_ID=$KAKAO_CLIENT_ID" >> .env
  - echo "KAKAO_CLIENT_SECRET=$KAKAO_CLIENT_SECRET" >> .env
  - echo "KAKAO_REDIRECT_URI=$KAKAO_REDIRECT_URI" >> .env
  - echo "KAKAO_REST_API_KEY=$KAKAO_REST_API_KEY" >> .env
  - echo "KAKAO_LOGOUT_REDIRECT_URI=$KAKAO_LOGOUT_REDIRECT_URI" >> .env

build_backend:
  stage: build
  script:
    - docker build -t $IMAGE_BACKEND:$TAG -f Backend/Dockerfile.dev
    - docker push $IMAGE_BACKEND:$TAG
  only:
    - develop
    - master

build_frontend:
  stage: build
  script:
    - docker build -t $IMAGE_FRONTEND:$TAG -f Frontend/Dockerfile.dev
    - docker push $IMAGE_FRONTEND:$TAG
  only:
    - develop
    - master

test:
  stage: test
  script:
    - docker-compose -f docker-compose.yml run --rm backend bash -c "
        uvicorn main:app --host 0.0.0.0 --port 8000 --reload --proxy-headers --forwarded-allow-ips='*'
      "
    - docker-compose -f docker-compose.yml run --rm frontend npm run dev
    - docker-compose down
  only:
    - develop

deploy:
  stage: deploy
  script:
    - echo "$DEPLOY_SSH_PRIVATE_KEY" > I12B106T.pem
    - chmod 400 I12B106T.pem
    - ssh -i ~/.ssh/id_rsa ubuntu@i12b106.p.ssafy.io "echo 'âœ… SSH connection successful'"
    - ssh ubuntu@i12b106.p.ssafy.io << EOF
        set -e
        docker pull $IMAGE_BACKEND:$TAG || { echo "Backend pull failed! Rolling back..."; exit 1; }
        docker pull $IMAGE_FRONTEND:$TAG || { echo "Frontend pull failed! Rolling back..."; exit 1; }
        docker-compose -f docker-compose.yml up -d
      EOF
  only:
    - master
    - release
