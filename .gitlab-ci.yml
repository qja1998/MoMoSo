stages:
  - build
  - test
  - deploy

variables:
  IMAGE_BACKEND: kwon0528/backend
  IMAGE_FRONTEND: kwon0528/frontend
  TAG: $CI_COMMIT_REF_NAME

before_script:
  - docker --version
  - docker-compose --version

  - docker info
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

  - mkdir -p ~/.ssh
  - echo "ğŸ”‘ Set ENV"

  - echo "DOCKER_USERNAME=$DOCKER_USERNAME" >> .env
  - echo "DOCKER_PASSWORD=$DOCKER_PASSWORD" >> .env
  - echo "DEPLOY_SSH_PRIVATE_KEY=$DEPLOY_SSH_PRIVATE_KEY" >> .env
  - echo "TWILIO_AUTH_TOKEN=$TWILIO_AUTH_TOKEN" >> .env
  - echo "TWILIO_VERIFY_SID=$TWILIO_VERIFY_SID" >> .env
  - echo "SECRET_KEY=$SECRET_KEY" >> .env
  - echo "ALGORITHM=$ALGORITHM" >> .env
  - echo "ACCESS_TOKEN_EXPIRE_MINUTES=$ACCESS_TOKEN_EXPIRE_MINUTES" >> .env
  - echo "REFRESH_TOKEN_EXPIRE_DAYS=$REFRESH_TOKEN_EXPIRE_DAYS" >> .env
  - echo "MAIL_USERNAME=$MAIL_USERNAME" >> .env
  - echo "MAIL_PASSWORD=$MAIL_PASSWORD" >> .env
  - echo "MAIL_FROM=$MAIL_FROM" >> .env
  - echo "MAIL_PORT=$MAIL_PORT" >> .env
  - echo "MAIL_SERVER=$MAIL_SERVER" >> .env
  - echo "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" >> .env
  - echo "GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET" >> .env
  - echo "KAKAO_CLIENT_ID=$KAKAO_CLIENT_ID" >> .env
  - echo "KAKAO_CLIENT_SECRET=$KAKAO_CLIENT_SECRET" >> .env
  - echo "KAKAO_REDIRECT_URI=$KAKAO_REDIRECT_URI" >> .env
  - echo "KAKAO_REST_API_KEY=$KAKAO_REST_API_KEY" >> .env
  - echo "KAKAO_LOGOUT_REDIRECT_URI=$KAKAO_LOGOUT_REDIRECT_URI" >> .env

build_backend:
  stage: build
  tags:
    - backend-runner
  script:
    - cd Backend
    - |
      if [[ "$TAG" == "develop" ]]; then
        docker build -t $IMAGE_BACKEND:$TAG -f Dockerfile.dev .
      else
        docker build -t $IMAGE_BACKEND:$TAG -f Dockerfile.prod .
      fi
    - docker push $IMAGE_BACKEND:$TAG
  only:
    - develop
    - release
    - master

build_frontend:
  stage: build
  tags:
    - frontend-runner
  script:
    - cd Frontend
    - |
      if [[ "$TAG" == "develop" ]]; then
        docker build -t $IMAGE_FRONTEND:$TAG -f Dockerfile.dev .
      else
        docker build -t $IMAGE_FRONTEND:$TAG -f Dockerfile.prod .
      fi
    - docker push $IMAGE_FRONTEND:$TAG
  only:
    - develop
    - release
    - master

test:
  stage: test
  tags:
    - test
  script:
    - docker-compose -f docker-compose.yml run --rm backend bash -c "
        uvicorn main:app --host 0.0.0.0 --port 8000 --reload --proxy-headers --forwarded-allow-ips='*'
      "
    - docker-compose -f docker-compose.yml run --rm frontend npm run dev
    - docker-compose down
  only:
    - develop

deploy:
  stage: deploy
  tags:
    - deploy
  before_script:
    - echo "$DEPLOY_SSH_PRIVATE_KEY" > id_rsa
    - chmod 600 id_rsa
    - ssh-keygen -p -m PEM -f id_rsa -N ""  # OpenSSH í˜¸í™˜ ë³€í™˜
    - mkdir -p ~/.ssh
    - ssh-keyscan -H $SSH_HOST > ~/.ssh/known_hosts  # SSH í˜¸ìŠ¤íŠ¸ í‚¤ ë“±ë¡
    - chmod 644 ~/.ssh/known_hosts
    - ssh -i id_rsa ubuntu@$SSH_HOST "echo SSH ì—°ê²° ì„±ê³µ"

  script:
    - |
      # 1ï¸âƒ£ ë¡œì»¬ì˜ docker-compose.ymlì„ ì›ê²© ì„œë²„ë¡œ ë³µì‚¬
      scp -i id_rsa docker-compose.yml ubuntu@$SSH_HOST:/home/ubuntu/docker-compose.yml
      
      # 2ï¸âƒ£ SSH ì ‘ì† í›„ Docker Compose ì‹¤í–‰
      ssh -i id_rsa ubuntu@$SSH_HOST << EOF
      set -e
      docker pull $IMAGE_BACKEND:$TAG || { echo "Backend pull failed! Rolling back..."; exit 1; }
      docker pull $IMAGE_FRONTEND:$TAG || { echo "Frontend pull failed! Rolling back..."; exit 1; }
      cd /home/ubuntu
      docker-compose -f docker-compose.yml up -d
      EOF
  only:
    - master
    - release
