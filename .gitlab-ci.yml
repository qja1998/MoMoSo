stages:
  - build
  - test
  - deploy

variables:
  # ê¸°ì¡´ íŒŒì¼ ìž”ìž¬ ë°©ì§€: ë§¤ Jobë§ˆë‹¤ ìƒˆë¡œìš´ clone ìˆ˜í–‰
  GIT_STRATEGY: clone
  GIT_CLEAN_FLAGS: "-ffdx"
  IMAGE_BACKEND: kwon0528/backend
  IMAGE_FRONTEND: kwon0528/frontend
  TAG: $CI_COMMIT_REF_NAME

before_script:
  # í˜¹ì‹œ ëª¨ë¥¼ ìž”ì—¬ íŒŒì¼ ì •ë¦¬ (ê¶Œí•œ ë¬¸ì œ ë°©ì§€)
  - echo "Cleaning workspace using git clean..."
  - git clean -ffdx
  - find . -type d -name "__pycache__" -exec chmod -R 777 {} \;
  - find . -type d -name "__pycache__" -exec rm -rf {} +

  # Docker ë¡œê·¸ì¸
  - docker --version
  - docker-compose --version
  - docker info
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

  # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
  - mkdir -p ~/.ssh
  - echo "ðŸ”‘ Set ENV"
  - echo "DOCKER_USERNAME=$DOCKER_USERNAME" >> .env
  - echo "DOCKER_PASSWORD=$DOCKER_PASSWORD" >> .env

build_backend:
  stage: build
  tags:
    - backend-runner
  script:
    - cd Backend
    - |
      if [[ "$TAG" == "develop" ]]; then
        docker build --build-arg UID=$(id -u) --build-arg GID=$(id -g) -t $IMAGE_BACKEND:$TAG -f Dockerfile.dev .
      else
        docker build --build-arg UID=$(id -u) --build-arg GID=$(id -g) -t $IMAGE_BACKEND:$TAG -f Dockerfile.prod .
      fi
    - docker push $IMAGE_BACKEND:$TAG
  only:
    - develop
    - release
    - master

build_frontend:
  stage: build
  tags:
    - frontend-runner
  script:
    - cd Frontend
    - |
      if [[ "$TAG" == "develop" ]]; then
        docker build -t $IMAGE_FRONTEND:$TAG -f Dockerfile.dev .
      else
        docker build -t $IMAGE_FRONTEND:$TAG -f Dockerfile.prod .
      fi
    - docker push $IMAGE_FRONTEND:$TAG
  only:
    - develop
    - release
    - master

test:
  stage: test
  tags:
    - test
  before_script:
    # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì „ ê°•ì œ í´ë¦°ì—… (íŠ¹ížˆ __pycache__ ê´€ë ¨ ê¶Œí•œ ë¬¸ì œ í•´ê²°)
    - find . -type d -name "__pycache__" -exec chmod -R 777 {} \;
    - find . -type d -name "__pycache__" -exec rm -rf {} +
  script:
    - echo "Running tests..."
    - docker-compose -f docker-compose.yml up -d
    - docker-compose -f docker-compose.yml run --rm backend pytest
    - docker-compose -f docker-compose.yml run --rm frontend npm run test
    - docker-compose down
  only:
    - develop

deploy:
  stage: deploy
  tags:
    - deploy
  before_script:
    - echo "$DEPLOY_SSH_PRIVATE_KEY" > id_rsa
    - chmod 600 id_rsa
    - ssh-keygen -p -m PEM -f id_rsa -N ""
    - mkdir -p ~/.ssh
    - ssh-keyscan -H $SSH_HOST > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - ssh -i id_rsa ubuntu@$SSH_HOST "echo SSH ì—°ê²° ì„±ê³µ"
  script:
    - |
      ssh -i id_rsa ubuntu@$SSH_HOST << EOF
      set -e
      echo "Pull docker images..."
      docker pull $IMAGE_BACKEND:$TAG || { echo "Backend pull failed! Rolling back..."; exit 1; }
      docker pull $IMAGE_FRONTEND:$TAG || { echo "Frontend pull failed! Rolling back..."; exit 1; }
      
      echo "Checking if docker-compose is running..."
      cd /home/ubuntu/S12P11B106
      if [ "$(docker ps -q)" ]; then
        echo "Stopping running services..."
        docker-compose down
      else
        echo "No running containers found."
      fi

      echo "Starting new docker-compose services..."
      docker-compose -f docker-compose.yml up -d
      EOF
  only
