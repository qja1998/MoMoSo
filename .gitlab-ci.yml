image: docker:latest

stages:
  - build
  - test
  - deploy

variables:
  DOCKER_HOST: "unix:///var/run/docker.sock"
  DOCKER_AUTH_CONFIG: '{"auths":{"https://index.docker.io/v1/":{"username":"$DOCKER_USERNAME","password":"$DOCKER_PASSWORD"}}}'
  IMAGE_BACKEND: kwon0528/b106-backend
  IMAGE_FRONTEND: kwon0528/b106-frontend
  TAG: $CI_COMMIT_REF_NAME

before_script:
  - apk add --no-cache docker-compose
  - mkdir -p ~/.ssh
  - echo "ğŸ”‘ Downloading Secure Files..."
  - securefiles download  # âœ… Secure Files ë‹¤ìš´ë¡œë“œ
  - mv $CI_PROJECT_DIR/.env .env  # âœ… `.env` íŒŒì¼ ì´ë™
  - export $(grep -v '^#' .env | xargs)  # âœ… í™˜ê²½ ë³€ìˆ˜ ì ìš©

build_backend:
  stage: build
  script:
    - docker build -t $IMAGE_BACKEND:$TAG -f Backend/Dockerfile.dev
    - docker push $IMAGE_BACKEND:$TAG
  only:
    - develop
    - master

build_frontend:
  stage: build
  script:
    - docker build -t $IMAGE_FRONTEND:$TAG -f Frontend/Dockerfile.dev
    - docker push $IMAGE_FRONTEND:$TAG
  only:
    - develop
    - master

test:
  stage: test
  script:
    - docker-compose -f docker-compose.yml run --rm backend bash -c "
        uvicorn main:app --host 0.0.0.0 --port 8000 --reload --proxy-headers --forwarded-allow-ips='*'
      "
    - docker-compose -f docker-compose.yml run --rm frontend npm run dev
    - docker-compose down
  only:
    - develop

deploy:
  stage: deploy
  script:
    - chmod 600 $CI_PROJECT_DIR/I12B106T.pem
    - mv $CI_PROJECT_DIR/I12B106T.pem ~/.ssh/id_rsa
    - ssh -i ~/.ssh/id_rsa ubuntu@i12b106.p.ssafy.io "echo 'âœ… SSH connection successful'"
    - ssh ubuntu@i12b106.p.ssafy.io << EOF
        set -e
        docker pull $IMAGE_BACKEND:$TAG || { echo "Backend pull failed! Rolling back..."; exit 1; }
        docker pull $IMAGE_FRONTEND:$TAG || { echo "Frontend pull failed! Rolling back..."; exit 1; }
        docker-compose -f docker-compose.yml up -d
      EOF
  only:
    - master
    - release
